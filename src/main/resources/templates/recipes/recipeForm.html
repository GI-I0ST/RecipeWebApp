<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Recipe Form</title>
</head>
<body>
<form id="recipe_form"
      th:method="((${recipe.id}) ? 'PUT' : 'POST')"
      th:action="@{/recipes/{postfix}(postfix=${recipe.id} ? ${recipe.id} : 'new')}"
      th:modelAttribute
      enctype="multipart/form-data">

    <div class="mb-3">
        <label for="recipe_form_title" class="form-label">title</label>
        <input type="text" th:field="${recipe.title}" id="recipe_form_title" class="form-control"/>
    </div>

    <div class="mb-3">
        <label for="recipe_form_image" class="form-label">image</label>
        <img th:src="@{/uploads/{image}(image=*{image})}" height="300">
        <input id="recipe_form_image" type="file" accept="image/*" th:field="${recipe.imageMultipart}" multiple="multiple" class="form-control"/>
    </div>

    <div class="mb-3">
        <label for="recipe_form_time" class="form-label">time</label>
        <input type="number" inputmode="numeric" min="0" value="30" th:field="${recipe.time}" id="recipe_form_time"
               class="form-control"/>
    </div>

    <div class="mb-3">
        <label for="recipe_form_calories" class="form-label">calories</label>
        <input type="number" inputmode="numeric" min="0" th:field="${recipe.calories}"
               id="recipe_form_calories" class="form-control"/>
    </div>

    <div class="mb-3">
        <label for="recipe_form_ingredients" class="form-label">ingredients</label>
        <input type="text" th:field="${recipe.ingredients}" id="recipe_form_ingredients" class="form-control"/>
    </div>

    <div id="recipe_form_steps">
        <th:block th:each="step, iStat : ${recipe.stepsList}">
            <div class="mb-3 recipe_step">
                <p class="step_direction" th:text="|Step ${iStat.count}|">Step:</p>
                <button type="button" class="btn btn-danger delete_step_button">-</button>
                <input type="text" th:value="${step.text}" th:name="|stepsList[${iStat.index}].text|" class="form-control"/>
            </div>
        </th:block>

        <div class="mb-3">
            <button type="button" id="recipe_form_add_step" class="btn btn-primary">Add step</button>
        </div>
    </div>

    <div class="mb-3">
        <button type="submit" class="btn btn-primary">Submit</button>
    </div>
</form>

<script>
    $(document).ready(function () {
        let step_list_size = [[${recipe.stepsList.size()}]]

        function remove_step(event) {
            event.stopPropagation();
            event.stopImmediatePropagation();

            step_list_size--;
            $(this).parent().remove();

            $(".step_direction").get().forEach(function (step, index) {
                step.innerHTML = "Step " + (index + 1) + ":";
            });
        }

        function add_step(event) {
            step_list_size++;

            $('#recipe_form_add_step').before("<div class=\"mb-3 recipe_step\">\n" +
                "            <p class=\"step_direction\">Step " + step_list_size + ":</p>\n" +
                "            <input type=\"text\" name=\"stepsList[" + (step_list_size - 1) + "].text\" class=\"form-control\"/>" +
                "            <button type=\"button\" class=\"btn btn-danger delete_step_button\">-</button>\n" +
                "        </div>");

            $('.recipe_step:last').children(".delete_step_button").on("click", remove_step);
        }

        $('#recipe_form_add_step').on("click", add_step);

        $('.delete_step_button').on("click", remove_step);
    });
</script>
</body>
</html>